<!--! -*- Mode: XML -*- -->
<?python
from weeklyupdates.util import feeddate
from urllib import quote, urlencode
import cherrypy
import human
import json
?>
<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:py="http://genshi.edgewall.org/"
     py:strip="True">
  <py:def function="genlink(*paths, **params)">${cherrypy.url('/%s' % '/'.join([quote(str(path)) for path in paths]))}<py:if test="len(params)">?${urlencode(params)}</py:if></py:def>

  <head py:match="head">
    ${select("*|text()")}
    <link type="text/css" rel="stylesheet" href="${cherrypy.url('/static/css/ui.css')}" />
    <link type="text/css" rel="stylesheet" href="${cherrypy.url('/static/css/bootstrap.css')}" />
    <link rel="icon" type="image/png" href="${genlink('static/weekly-updates-icon.png')}"/>
  </head>

  <body py:match="body" class="normalcols" py:attrs="select('@*')">
    <div class="header">
      <h3><a href="${genlink('')}">Mozilla Status Board</a>
        <py:if test="loginid is not None">
          <span class="pull-right small text-muted hidden-xs">${loginid}</span>
        </py:if>
        <py:if test="'firefox' in team">
          <span class="pull-right small text-muted hidden-xs dates">${daysleft}
            ${'day' if daysleft==1 else 'days'} remaining in iteration ${iteration}</span>
        </py:if>
      </h3>
    </div>
    <div id="content">
    ${select("*|text()")}
    </div>
    <form id="login" action="${genlink('login')}" method="POST">
      <input type="hidden" name="loginAssertion" id="loginAssertion"/>
      <input type="hidden" name="returnTo" value="${cherrypy.url('')}"/>
    </form>
    <script type="text/javascript">
      var gUsername = ${json.dumps(loginid)};
      var kPreviewURL = "${genlink('preview')}";
    </script>
    <script type="text/javascript" src="https://login.persona.org/include.js" />
    <script type="text/javascript" src="${genlink('/static/js/persona.js')}" />
    <script type="text/javascript" src="${genlink('/static/js/bootstrap.js')}" />
  </body>

  <a py:match="a[@class='feedlink']" py:attrs="select('@*')" type="application/atom+xml">
    <img class="feedicon" src="${genlink('static/feed-icon-14x14.png')}" height="14" width="14"/>
  </a>

  <select py:match="select[@initialvalue]"
          py:with="selectvalue=str(select('@initialvalue'))"
          py:attrs="select('@*')">
    ${select("*|text()")}
  </select>

  <option py:match="option" py:attrs="select('@*')"
          selected="${(selectvalue == str(select('@value'))) and 'selected' or ''}">
    ${select("*|text()")}
  </option>

  <div py:def="postdetail(post, showuser=True, showdate=True,
                          cssclass='postdetail')"
       class="${cssclass}">
    <py:choose test="post.userid">
      <py:when test="None">
        <div class="postdata">
          <p>No status posted</p>
        </div>
      </py:when>
      <py:otherwise>
        <h4 py:if="showuser" class="postuser"><a href="${genlink('user', post.userid)}">
          <img class="avatar" src="https://avatars.io/email/${post.userid}" />${post.userid}</a>
          <small py:if="showdate" class="pull-right" title="Posted on ${post.postdate.isoformat()}">
            <span class="glyphicon glyphicon-time"></span>
            Posted ${human.date(post.postdate, asdays=True)}
          </small>
        </h4>

        <div class="postdata">
          <div class="newlines" py:if="post.bugs">
            <h4 class="posthead">Bugs:</h4>
            <p><py:for each="bug in post.bugs">
              <a title="${bug.summary}" href="https://bugzilla.mozilla.org/show_bug.cgi?id=${bug.id}"
                >Bug ${bug.id}</a> - ${bug.status_text}
            </py:for></p>
          </div>

          <div class="completed newlines" py:if="post.completed is not None">
            <h4 class="posthead">Done:</h4> ${post.getcompleted()}
          </div>

          <div class="planned newlines" py:if="post.planned is not None">
            <h4 class="posthead">Next:</h4> ${post.getplanned()}
          </div>

          <div class="tags newlines" py:if="post.tags is not None">
            <h4 class="posthead">Coordination:</h4> ${post.gettags()}
          </div>
        </div>
      </py:otherwise>
    </py:choose>
  </div>

  <div py:def="postlist(posts, showuser=True)" class="postlist">
    <py:for each="post in posts">
      ${postdetail(post, showuser=showuser, cssclass='postlistdetail')}
    </py:for>
  </div>

  <div py:def="loginform()">
    <input type="button" value="Log in" onclick="doLogin()" />
  </div>

  <form py:def="editpost(post)" class="editpost bordered bugpost"
        action="${genlink('post')}" method="POST" id="postform"
	onsubmit="clearPreview()">

    <div class="fullwidth bugs">
      <div class="col1">
        <div class="bordered">
          <py:choose>
            <py:when test="'firefox' in team">
              <div class="header none" py:if="not bugs">No bugs.</div>
              <h4 class="header" py:if="bugs" >Current bugs you have committed to in
              this iteration.</h4>
              <ul>
              <py:for each="bug in bugs">
                <li><div class="bug"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=${bug.id}"
                  >Bug ${bug.id}</a> - ${bug.summary}</div>
                  <div class="bugProgress">
                    <input type="radio" name="bug${bug.id}" value="notstarted"
                      checked="${'checked' if bug.status == 'notstarted' else ''}">Not Started</input>
                    <input type="radio" name="bug${bug.id}" value="inprogress"
                      checked="${'checked' if bug.status == 'inprogress' else ''}">In Progress</input>
                    <input type="radio" name="bug${bug.id}" value="inreview"
                      checked="${'checked' if bug.status == 'inreview' else ''}">In Review</input>
                  </div>
                </li>
              </py:for>
              </ul>
            </py:when>
            <py:otherwise>
              <py:if test="loginid is not None">
                <h2>Current Status
                  <span class="subhead" py:if="userposts[0].postdate is not None">
                    - Posted on ${userposts[0].postdate.isoformat()}
                  </span>
                </h2>
                ${postdetail(userposts[0], showuser=False, showdate=False)}
              </py:if>
            </py:otherwise>
          </py:choose>
        </div>

        <iframe id="previewFrame" name="previewFrame" class="hidden fullwidth"/>
        <div id="previewOuter" class="hidden fullwidth bordered">
          <h4>Preview:</h4>
          <div id="previewInner" />
        </div>
      </div>
      <div class="status col2">
        <div class="bordered">
          <div class="right-note"><a href="${genlink('markup')}" target="markup">Markdown Details</a></div>
          <py:choose>
            <py:when test="'firefox' in team">
              <h4>1. What did you do yesterday?</h4>
            </py:when>
            <py:otherwise>
              <h4>Done</h4>
            </py:otherwise>
          </py:choose>
          <p><textarea id="completed" name="completed" class="fullwidth"
            rows="${post.completed and post.completed.count('\n') + 1 or 1}">${post.completed}</textarea></p>

          <py:choose>
            <py:when test="'firefox' in team">
              <h4>2. What will you do today?</h4>
            </py:when>
            <py:otherwise>
              <h4>Next</h4>
            </py:otherwise>
          </py:choose>
          <p><textarea id="planned" name="planned" class="fullwidth"
            rows="${post.planned and post.planned.count('\n') + 1 or 1}">${post.planned}</textarea></p>

          <py:choose>
            <py:when test="'firefox' in team">
              <h4>3. Are you blocked on anything?  What?</h4>
            </py:when>
            <py:otherwise>
              <h4>Coordination</h4>
            </py:otherwise>
          </py:choose>
          <p><textarea id="tags" name="tags" class="fullwidth"
            rows="${post.tags and post.tags.count('\n') + 1 or len(bugs)}"><py:choose
            ><py:when test="post.tags">${post.tags}</py:when
            ><py:otherwise>${"\n".join("Bug %d - " % (bug.id,) for bug in bugs)}</py:otherwise
          ></py:choose></textarea></p>

          <input py:if="post.postdate is not None"
                 type="hidden" name="isedit" value="1"/>
        </div>
      </div>

      <br clear="both"/>
      <input type="submit" value="Submit"/>
      <input type="button" value="Preview" onclick="doPreview()"/>
    </div>
  </form>
</div>
